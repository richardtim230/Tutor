<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CODECX | Live Coding Class</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- TailwindCSS CDN for quick styling -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- Monaco Editor (VS Code) -->
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.min.js"></script>
  <!-- Socket.io client -->
  <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.7.5/dist/socket.io.min.js"></script>
  <style>
    html, body { height: 100%; margin: 0; }
    #monaco { width: 100%; height: 340px; border-radius: 10px; }
    .scroll-area { overflow-y: auto; max-height: 180px;}
    .resource-link:hover { text-decoration: underline;}
  </style>
</head>
<body class="bg-gradient-to-tr from-indigo-50 via-purple-50 to-white min-h-screen">
  <header class="flex items-center bg-white shadow px-8 py-4 justify-between sticky top-0 z-50">
    <div class="flex items-center gap-4">
      <img src="logo.png" alt="Codecx" class="h-10 w-10 rounded-full" />
      <h1 class="font-extrabold text-2xl text-indigo-800">Live Coding Class</h1>
    </div>
    <div class="flex items-center gap-3">
      <span id="userRole" class="inline-block bg-indigo-100 px-4 py-2 rounded-lg font-bold text-indigo-700"></span>
    </div>
  </header>
  <main class="flex flex-col xl:flex-row gap-8 max-w-7xl mx-auto px-4 pt-8 pb-16">
    <!-- Left/Class Section -->
    <section class="flex-1 flex flex-col gap-7">

      <!-- VIDEO (Jitsi Embed) -->
      <div class="bg-gray-50 p-4 rounded-lg shadow">
        <h2 class="text-lg font-bold text-indigo-800 mb-2">Live Class Video & Audio</h2>
        <iframe
          id="jitsi"
          src="https://meet.jit.si/codecxliveclass"
          allow="camera; microphone; fullscreen; display-capture"
          style="width: 100%; height: 360px; border-radius: 8px;"
          allowfullscreen
        ></iframe>
      </div>

      <!-- MONACO CODE EDITOR -->
      <section class="bg-white rounded-lg shadow p-4">
        <div class="flex justify-between items-center mb-2">
          <h2 class="font-bold text-lg text-indigo-700">Shared Live Code Editor</h2>
          <select id="codeLang" class="border px-2 py-1 rounded ml-auto">
            <option value="javascript">JavaScript</option>
            <option value="python">Python</option>
            <option value="html">HTML</option>
            <option value="css">CSS</option>
            <option value="java">Java</option>
          </select>
        </div>
        <div id="monaco"></div>
        <div class="text-xs text-gray-600 mt-2">
          Type in the editor. Everyone sees what you type.
          <br/>
          <span class="text-indigo-500">[Ctrl+S]</span> Save, <span class="text-indigo-500">[Tab]</span> Indent, <span class="text-indigo-500">[Shift+Tab]</span> Unindent.  
        </div>
      </section>

      <!-- RESOURCES: FILE SHARE -->
      <section class="bg-gray-50 rounded-lg shadow p-4 mt-0">
        <div class="flex items-center gap-4 mb-2 justify-between">
          <h2 class="font-bold text-gray-700">Shared Resources / Downloads</h2>
          <input type="file" id="fileInput" class="hidden"/>
          <button id="uploadBtn" class="bg-indigo-600 text-white px-3 py-2 rounded">Upload file</button>
        </div>
        <ul class="pl-4" id="resourceList"></ul>
        <div id="uploadStatus" class="text-sm text-red-500 mt-1"></div>
      </section>

    </section>

    <!-- Right CHAT/Q&A Section -->
    <aside class="w-full xl:w-[370px] flex flex-col gap-6">
      <!-- CLASS CHAT -->
      <section class="bg-white rounded-lg shadow p-4 flex flex-col h-[320px]">
        <h2 class="font-bold text-lg text-indigo-700 mb-1">Class Chat</h2>
        <div class="flex-1 mb-2 border rounded px-2 py-1 bg-gray-50 scroll-area" id="chatArea"></div>
        <form class="flex gap-1 mt-1" id="chatForm" autocomplete="off">
          <textarea id="chatInput" rows="1" placeholder="Type message... (Enter: send, Shift+Enter: newline)" class="flex-1 border rounded px-2 py-1 resize-none"></textarea>
          <button type="submit" id="sendBtn" class="bg-indigo-700 text-white px-4 rounded">Send</button>
        </form>
      </section>
      <!-- POLL Q&A -->
      <section class="bg-gray-50 rounded-lg shadow p-4" id="pollQA">
        <h2 class="font-bold text-gray-700 mb-2">Live Q&amp;A / Polls</h2>
        <form id="pollForm" class="mb-2">
          <input name="question" type="text" placeholder="Start a poll: Your question..." class="border rounded px-2 py-1 mb-1 w-full" required />
          <input name="opt1" type="text" placeholder="Option 1" class="border rounded px-2 py-1 mb-1 w-full" required />
          <input name="opt2" type="text" placeholder="Option 2" class="border rounded px-2 py-1 mb-1 w-full" required />
          <input name="opt3" type="text" placeholder="Option 3" class="border rounded px-2 py-1 mb-1 w-full" required />
          <input name="opt4" type="text" placeholder="Option 4" class="border rounded px-2 py-1 mb-1 w-full" required />
          <button type="submit" class="bg-indigo-800 text-white px-3 py-1 rounded">Send Poll</button>
        </form>
        <div id="pollLive" class="text-sm"></div>
      </section>
    </aside>
  </main>
  <script>
    // -- BACKEND CONFIG
    const BACKEND = "https://examguard-jmvj.onrender.com";

    // --- 1. Authentication & Setup ---
    let token = localStorage.getItem("codecx_token");
    if(!token) token = sessionStorage.getItem("codecx_token");
    if(!token) token = prompt("Provide login token:");
    if(!token) { alert("Login required!"); location.href='login.html'; }
    function decodeJWT(token) {
      try { return JSON.parse(atob(token.split('.')[1])); } catch(e) { return {}; }
    }
    let user = decodeJWT(token);
    let displayName =
      user.fullName || user.username || user.matricNumber || "Guest";
    document.getElementById("userRole").textContent = displayName;

    // --- 2. Socket.io real-time connection ---
    const socket = io(BACKEND, { 
      query: { token }, 
      path: "/liveclass-socket", 
      transports: ["websocket"], 
      withCredentials: true 
    });

    // --- 3. Class Chat ---
    let chatArea = document.getElementById('chatArea');
    let chatInput = document.getElementById("chatInput");
    let sendBtn = document.getElementById("sendBtn");

    // Allow Shift+Enter for newline, Enter for send
    chatInput.addEventListener("keydown", function (e) {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
      }
    });
    document.getElementById('chatForm').onsubmit = e => {
      e.preventDefault();
      let msg = chatInput.value.trim();
      if(msg) {
        socket.emit("chat:message", { 
          user: displayName, 
          message: msg, 
          time: new Date().toISOString() 
        });
        chatInput.value = "";
        chatInput.rows = 1;
      }
    };
    chatInput.addEventListener("input", function() {
      // dynamically size textarea to content
      chatInput.rows = Math.min(6, chatInput.value.split("\n").length);
    });
    socket.on("chat:message", msg=>{
      let div = document.createElement("div");
      div.innerHTML = `<span class="font-semibold text-indigo-700">${msg.user}</span>: <span>${msg.message.replace(/\n/g, "<br/>")}</span> <span class="text-xs ml-2 text-gray-400">${new Date(msg.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>`;
      chatArea.appendChild(div); chatArea.scrollTop = chatArea.scrollHeight;
    });

    // --- 4. MONACO CODE EDITOR with full collaborative sync ---
    let editor, codeModel, codeModelIgnore = false;
    let monacoLang = "javascript";
    document.getElementById('codeLang').onchange = function() {
      let newLang = this.value;
      monacoLang = newLang;
      if (codeModel) monaco.editor.setModelLanguage(codeModel, newLang);
    };
    // Monaco load
    require.config({ paths: { vs: "https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs" }});
    require(['vs/editor/editor.main'], function () {
      // Always show a starter code even if backend doesn't send one yet
      let starterCode = "<!-- Welcome to CODECX Collaborative Code. Start Coding! -->";
      codeModel = monaco.editor.createModel(starterCode, monacoLang);

      editor = monaco.editor.create(document.getElementById('monaco'), {
        model: codeModel,
        theme: "vs-dark",
        fontSize: 16, minimap: { enabled: false }
      });

      // Collaborative: broadcast on change
      editor.onDidChangeModelContent(() => {
        if(editor.isFocused() && !codeModelIgnore) {
          socket.emit("code:update", codeModel.getValue());
        }
      });

      // Sync code from server (prevents feedback loops)
      socket.on("code:update", code=>{
        if(code !== codeModel.getValue()) {
          codeModelIgnore = true;
          codeModel.setValue(code);
          codeModelIgnore = false;
        }
      });

      // On initial connection or rejoin, get the latest code from others
      socket.on("code:init", code=>{
        if(code && code !== codeModel.getValue()) {
          codeModel.setValue(code);
        }
      });
    });

    // --- 5. Poll/Q&A (with results for ALL) ---
    let pollForm = document.getElementById("pollForm"),
        pollLive = document.getElementById("pollLive");
    pollForm.classList.remove("hidden"); // anyone can start a poll!
    pollForm.onsubmit = function(e) {
      e.preventDefault();
      const q = pollForm.question.value.trim(),
        opts = [pollForm.opt1.value, pollForm.opt2.value, pollForm.opt3.value, pollForm.opt4.value];
      if(q && opts.every(o=>o.trim())) {
        socket.emit("quiz:question", { q, opts });
        pollForm.reset();
      }
    };
    socket.on("quiz:question", d => {
      pollLive.innerHTML =
        `<div class="font-semibold mb-1">${d.q}</div>` +
        d.opts.map((o,i)=>
          `<button data-i="${i}" class="bg-indigo-100 px-2 m-1 rounded text-indigo-800 poll-opt-btn">${String.fromCharCode(65+i)}. ${o}</button><br>`
        ).join("") +
        `<div id="pollResults" class="mt-2"></div>`;
      pollLive.querySelectorAll(".poll-opt-btn").forEach(btn=>{
        btn.onclick = function() {
          let idx = btn.getAttribute("data-i");
          socket.emit("quiz:answer", parseInt(idx));
          pollLive.innerHTML += `<div class="text-green-700 mt-2">Answered (${String.fromCharCode(65+parseInt(idx))})</div>`;
          pollLive.querySelectorAll(".poll-opt-btn").forEach(b=>b.disabled = true);
        };
      });
    });
    socket.on("quiz:results", counts=>{
      let pollResults = document.getElementById("pollResults");
      if (!pollResults) return;
      pollResults.innerHTML = Object.entries(counts)
        .map(([i, v]) => `<div>${String.fromCharCode(65+parseInt(i))}: <b>${v}</b> vote${v==1?"":"s"}</div>`)
        .join("");
    });

    // --- 6. File upload/download sharing (everyone can upload files) ---
    let uploadBtn = document.getElementById("uploadBtn");
    let fileInput = document.getElementById("fileInput");
    uploadBtn.onclick = ()=>fileInput.click();
    fileInput.onchange = async function() {
      let file = fileInput.files[0];
      if (!file) return;
      uploadBtn.disabled = true;
      uploadBtn.textContent = "Uploading...";
      let uploadStatus = document.getElementById('uploadStatus');
      uploadStatus.textContent = "";
      try {
        let form = new FormData();
        form.append("file", file);
        let res = await fetch(BACKEND+"/api/liveclass/files/upload", { method:"POST", headers:{"Authorization":"Bearer "+token}, body:form });
        let data = await res.json();
        if(data.url) {
          socket.emit("file:uploaded", { name: file.name, url: data.url });
        } else if(data.message) {
          uploadStatus.textContent = "Failed: "+data.message;
        }
      } catch(e) { 
        uploadStatus.textContent = "Upload failed! Network or permissions error.";
      }
      uploadBtn.disabled = false;
      uploadBtn.textContent = "Upload file";
    }
    let resourceList = document.getElementById("resourceList");
    socket.on("file:uploaded", ({name, url})=>{
      let li = document.createElement("li");
      li.innerHTML = `<a href="${url}" class="text-indigo-700 font-semibold resource-link" target="_blank" download>${name}</a>`;
      resourceList.appendChild(li);
    });

    // --- 7. Error Handling
    socket.on("connect_error", (err)=>{
      alert("Failed to connect to class server: "+(err&&err.message?err.message:err));
    });

  </script>
</body>
</html>
