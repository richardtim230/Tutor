<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CODECX | Live Coding Class</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- TailwindCSS CDN for quick styling -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- Monaco Editor (VS Code) -->
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.min.js"></script>
  <!-- Socket.io (for chat/collaboration)—ensure your backend serves socket.io on /liveclass-socket -->
  <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.7.5/dist/socket.io.min.js"></script>
  <style>
    html, body { height: 100%; margin: 0; }
    #monaco { width: 100%; height: 340px; border-radius: 10px; }
    .scroll-area { overflow-y: auto; max-height: 180px;}
    .resource-link:hover { text-decoration: underline;}
  </style>
</head>
<body class="bg-gradient-to-tr from-indigo-50 via-purple-50 to-white min-h-screen">
  <header class="flex items-center bg-white shadow px-8 py-4 justify-between sticky top-0 z-50">
    <div class="flex items-center gap-4">
      <img src="logo.png" alt="Codecx" class="h-10 w-10 rounded-full" />
      <h1 class="font-extrabold text-2xl text-indigo-800">Live Coding Class</h1>
    </div>
    <div class="flex items-center gap-3">
      <span id="userRole" class="inline-block bg-indigo-100 px-4 py-2 rounded-lg font-bold text-indigo-700"></span>
    </div>
  </header>
  <main class="flex flex-col xl:flex-row gap-8 max-w-7xl mx-auto px-4 pt-8 pb-16">
    <!-- Left/Class Section -->
    <section class="flex-1 flex flex-col gap-7">

      <!-- VIDEO (Jitsi Embed) -->
      <div class="bg-gray-50 p-4 rounded-lg shadow">
        <h2 class="text-lg font-bold text-indigo-800 mb-2">Live Class Video & Audio</h2>
        <iframe
          id="jitsi"
          src="https://meet.jit.si/codecxliveclass"
          allow="camera; microphone; fullscreen; display-capture"
          style="width: 100%; height: 360px; border-radius: 8px;"
          allowfullscreen
        ></iframe>
      </div>

      <!-- MONACO CODE EDITOR -->
      <section class="bg-white rounded-lg shadow p-4">
        <div class="flex justify-between items-center mb-2">
          <h2 class="font-bold text-lg text-indigo-700">Shared Live Code Editor</h2>
          <select id="codeLang" class="border px-2 py-1 rounded ml-auto">
            <option value="javascript">JavaScript</option>
            <option value="python">Python</option>
            <option value="html">HTML</option>
            <option value="css">CSS</option>
            <option value="java">Java</option>
          </select>
        </div>
        <div id="monaco"></div>
        <div class="text-xs text-gray-500 mt-2">Edits here are live and real-time for everyone in the class.</div>
      </section>

      <!-- RESOURCES: FILE SHARE -->
      <section class="bg-gray-50 rounded-lg shadow p-4 mt-0">
        <div class="flex items-center gap-4 mb-2 justify-between">
          <h2 class="font-bold text-gray-700">Shared Resources / Downloads</h2>
          <input type="file" id="fileInput" class="hidden"/>
          <button id="uploadBtn" class="bg-indigo-600 text-white px-3 py-2 rounded hidden">Upload file</button>
        </div>
        <ul class="pl-4" id="resourceList"></ul>
      </section>

    </section>

    <!-- Right CHAT/Q&A Section -->
    <aside class="w-full xl:w-[370px] flex flex-col gap-6">
      <!-- CLASS CHAT -->
      <section class="bg-white rounded-lg shadow p-4 flex flex-col h-[320px]">
        <h2 class="font-bold text-lg text-indigo-700 mb-1">Class Chat</h2>
        <div class="flex-1 mb-2 border rounded px-2 py-1 bg-gray-50 scroll-area" id="chatArea"></div>
        <form class="flex gap-1 mt-1" id="chatForm">
          <input id="chatInput" type="text" placeholder="Message" class="flex-1 border rounded px-2 py-1"/>
          <button type="submit" class="bg-indigo-700 text-white px-4 rounded">Send</button>
        </form>
      </section>
      <!-- POLL Q&A -->
      <section class="bg-gray-50 rounded-lg shadow p-4" id="pollQA">
        <h2 class="font-bold text-gray-700 mb-2">Live Q&amp;A</h2>
        <form id="pollForm" class="mb-2 hidden">
          <input name="question" type="text" placeholder="Ask a question..." class="border rounded px-2 py-1 mb-1 w-full" required />
          <input name="opt1" type="text" placeholder="Option 1" class="border rounded px-2 py-1 mb-1 w-full" required />
          <input name="opt2" type="text" placeholder="Option 2" class="border rounded px-2 py-1 mb-1 w-full" required />
          <input name="opt3" type="text" placeholder="Option 3" class="border rounded px-2 py-1 mb-1 w-full" required />
          <input name="opt4" type="text" placeholder="Option 4" class="border rounded px-2 py-1 mb-1 w-full" required />
          <button type="submit" class="bg-indigo-800 text-white px-3 py-1 rounded">Send Poll</button>
        </form>
        <div id="pollLive" class="text-sm"></div>
      </section>
    </aside>
  </main>
  <script>
    // -- BACKEND URL
    const BACKEND = "https://examguard-jmvj.onrender.com";
    // --- 1. Authentication ---
    let token = localStorage.getItem("codecx_token") || prompt("Provide login token:");
    if(!token) { alert("Login required!"); location.href='login.html'; }
    function decodeJWT(token) {
      try { return JSON.parse(atob(token.split('.')[1])); } catch(e) { return {}; }
    }
    let user = decodeJWT(token);
    let role = (user.role === "admin" || user.role === "instructor") ? "instructor" : "student";
    document.getElementById("userRole").textContent = user.fullName + " (" + role + ")";

    // --- 2. Socket.io real-time stuff ---
    const socket = io(BACKEND, { query: { token }, path: "/liveclass-socket", transports: ["websocket"] });

    // --- 3. Class Chat ---
    let chatArea = document.getElementById('chatArea');
    document.getElementById('chatForm').onsubmit = e => {
      e.preventDefault();
      let input = document.getElementById('chatInput');
      let msg = input.value.trim();
      if(msg) {
        socket.emit("chat:message", { user: user.fullName, message: msg, time: new Date().toISOString() });
        input.value = "";
      }
    };
    socket.on("chat:message", msg=>{
      let div = document.createElement("div");
      div.innerHTML = `<span class="font-semibold text-indigo-700">${msg.user}</span>: <span>${msg.message}</span> <span class="text-xs ml-2 text-gray-400">${new Date(msg.time).toLocaleTimeString()}</span>`;
      chatArea.appendChild(div); chatArea.scrollTop = chatArea.scrollHeight;
    });

    // --- 4. Monaco Editor (collaboration) ---
    let editor, codeModel;
    let monacoLang = "javascript";
    document.getElementById('codeLang').onchange = function() {
      let newLang = this.value;
      monacoLang = newLang;
      monaco.editor.setModelLanguage(codeModel, newLang);
    };
    require.config({ paths: { vs: "https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs" }});
    require(['vs/editor/editor.main'], function () {
      codeModel = monaco.editor.createModel("// Class code appears here", monacoLang);
      editor = monaco.editor.create(document.getElementById('monaco'), {
        model: codeModel,
        theme: "vs-dark",
        fontSize: 16, minimap: { enabled: false }
      });
      editor.onDidChangeModelContent(() => {
        if(editor.isFocused()) socket.emit("code:update", codeModel.getValue());
      });
      socket.on("code:update", code=>{
        if(code !== codeModel.getValue()) codeModel.setValue(code);
      });
    });

    // --- 5. Poll/Q&A ---
    let pollForm = document.getElementById("pollForm"), pollLive = document.getElementById("pollLive");
    if(role==="instructor") pollForm.classList.remove("hidden");
    pollForm.onsubmit = function(e) {
      e.preventDefault();
      const q = pollForm.question.value, opts = [pollForm.opt1.value, pollForm.opt2.value, pollForm.opt3.value, pollForm.opt4.value];
      socket.emit("quiz:question", { q, opts });
    };
    socket.on("quiz:question", d => {
      // For students: answer form; instructor: live result
      pollLive.innerHTML =
        `<div class="font-semibold">${d.q}</div>` +
        (role==="student"?d.opts.map((o,i)=>
          `<button data-i="${i}" class="bg-indigo-100 px-2 m-1 rounded text-indigo-800" onclick="window.submitAns(this)">${String.fromCharCode(65+i)}. ${o}</button><br>`).join("")
        : d.opts.map((o,i)=>`${String.fromCharCode(65+i)}. ${o} — <span id="c${i}">0</span> votes<br>`).join(""));
      if(role==="student") window.submitAns = function(btn){
        let idx = btn.getAttribute("data-i");
        socket.emit("quiz:answer", parseInt(idx));
        pollLive.innerHTML += `<div class="text-green-700 mt-2">Answered (${String.fromCharCode(65+parseInt(idx))})</div>`;
      };
    });
    socket.on("quiz:results", counts=>{
      for(let i in counts) { let el = document.getElementById("c"+i); if(el) el.textContent=counts[i]; }
    });

    // --- 6. File upload/download sharing (for instructor only) ---
    let uploadBtn = document.getElementById("uploadBtn");
    if(role==="instructor") uploadBtn.classList.remove("hidden");
    let fileInput = document.getElementById("fileInput");
    uploadBtn.onclick = ()=>fileInput.click();
    fileInput.onchange = async function() {
      let file = fileInput.files[0];
      let form = new FormData(); form.append("file", file);
      let res = await fetch(BACKEND+"/api/files/upload", { method:"POST", headers:{"Authorization":token}, body:form });
      let data = await res.json();
      if(data.url) socket.emit("file:uploaded", { name: file.name, url: data.url });
    }
    let resourceList = document.getElementById("resourceList");
    socket.on("file:uploaded", ({name, url})=>{
      let li = document.createElement("li");
      li.innerHTML = `<a href="${url}" class="text-indigo-700 font-semibold resource-link" target="_blank">${name}</a>`;
      resourceList.appendChild(li);
    });

    // --- INIT: On load, get initial code & resources if desired (optional) ---
    // e.g., fetch(BACKEND+'/api/class-state').then...

    // Additional: You may plug in class recording, attendance via extra endpoints/webhooks.

  </script>
</body>
</html>
