<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CODECX Institute Student Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1/themes/prism.css">
<script src="https://cdn.jsdelivr.net/npm/prismjs@1/prism.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1/plugins/autoloader/prism-autoloader.min.js"></script>
  <style>
    body {
      background: #f6f7fb;
      min-height: 100vh;
      font-family: "Inter", "Segoe UI", "Arial", sans-serif;
    }
    header {
      background: #fff;
      box-shadow: 0 2px 8px #c7d2fe38;
      padding: 1.1rem 1.2rem;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      min-width: 0;
    }
    header h1 {
      font-size: 2rem;
      font-weight: bold;
      color: #3f298a;
      min-width: 0;
      flex: 1 1 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    header .feature-badge {
      background: #6366f1;
      color: #fff;
      font-size: .95rem;
      border-radius: 8px;
      padding: .15rem .5rem;
      font-weight: 600;
      margin-left: .7rem;
      display: inline-block;
      white-space: nowrap;
    }
    @media (max-width: 900px) {
      main {
        padding-left: 0 !important;
        padding-right: 0 !important;
      }
      .grid-cols-2,
      .grid-cols-4 {
        grid-template-columns: 1fr !important;
      }
    }
    @media (max-width: 600px) {
      header h1 {
        font-size: 1.1rem;
        padding-right: 0;
      }
      header .feature-badge {
        font-size: 0.85rem;
        padding: .13rem .35rem;
      }
      #studentNameHeader {
        max-width: 60px;
      }
      section {
        padding: 1rem !important;
      } 
      .resource-card {
        padding: 0.7rem 0.6rem;
      }
      .scroll-area {
        padding: 0.6rem;
        font-size: 0.97rem;
      }
      main {
        padding-left: 0 !important;
        padding-right: 0 !important;
      }
    }
    .locked {
      filter: grayscale(0.7) blur(1px);
      position: relative;
      pointer-events: none;
      opacity: 0.7;
    }
    .locked::before {
      content: '';
      position: absolute;
      inset: 0;
      background: rgba(255,255,255,0.4);
      border-radius: 1rem;
      z-index: 1;
    }
    .padlock-icon {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      font-size: 2.5rem;
      color: #6366f1;
      z-index: 2;
      pointer-events: none;
      opacity: 0.9;
    }
    .feature-section {
      position: relative;
      overflow: hidden;
    }
    .feature-section .padlock-icon {
      pointer-events: none;
    }
    .feature-section.locked * {
      pointer-events: none;
    }
    .feature-section.locked .padlock-icon {
      display: block;
    }
    main {
      max-width: 1100px;
      margin: 0 auto;
      padding: 2.5rem 1.2rem;
    }
    section {
      background: #fff;
      border-radius: 1.2rem;
      box-shadow: 0 2px 16px #6366f117;
      padding: 2rem 2rem;
      margin-bottom: 2rem;
    }
    .resource-card {
      background: #fff;
      border-radius: 1rem;
      box-shadow: 0 2px 10px #6366f11a;
      padding: 1.1rem 1.2rem;
      margin-bottom: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      min-width: 0;
    }
    .resource-card .title {
      font-weight: 700;
      color: #4338ca;
      font-size: 1.07rem;
      word-break: break-word;
    }
    .resource-card .desc {      color: #444;
      font-size: 0.97rem;
      word-break: break-word;
    }
    .resource-card .link {
      color: #6366f1;
      font-weight: 500;
      text-decoration: underline;
      font-size: 0.97rem;
      margin-top: .5rem;
      word-break: break-word;
    }
    #studentPassport {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 2px solid #eef2ff;
    }
    #studentStatus span {
      display: inline-block;
      padding: 0.25rem 0.7rem;
      border-radius: 7px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    .grid {
      display: grid;
      gap: 1.3rem;
    }
    .grid-cols-2 {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
    .grid-cols-4 {
      grid-template-columns: repeat(4, minmax(0, 1fr));
    }
    .scroll-area {
      max-height: 280px;
      overflow-y: auto;
      border-radius: 1rem;
      background: #f8fafc;
      padding: 1rem;
      margin-bottom: 1.2rem;
    }
    .chat-message {
      margin-bottom: 1.1rem;
      display: flex;
      gap: 0.7rem;
      align-items: flex-start;
      word-break: break-word;
    }
    .chat-message .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #e0e7ff;
      object-fit: cover;
      flex-shrink: 0;
    }
    .chat-message .bubble {
      background: #f3f4f6;
      color: #312e81;
      border-radius: 1rem 1rem 1rem 0.6rem;
      padding: 0.7rem 1.1rem;
      font-size: 1rem;
      max-width: 80vw;
      box-shadow: 0 2px 8px #6366f111;
      word-break: break-word;
    }
    .chat-message.me .bubble {
      background: #6366f1;
      color: #fff;
      border-radius: 1rem 1rem 0.6rem 1rem;
    }
    .chat-message.me {
      flex-direction: row-reverse;
    }
    /* Progress Section - Improved */
    #progressSection {}
    #progressSummary {
      font-size: 1.09rem;
      color: #4338ca;
      margin-bottom: 1.1rem;
      font-weight: 600;
    }
    #progressBar {
      width: 100%;
      background: #e5e7eb;
      border-radius: 9999px;
      height: 1.1rem;
      margin-bottom: 1.6rem;
      overflow: hidden;
      box-shadow: 0 2px 8px #6366f111;
      position: relative;
    }
    #progressBarFill {
      height: 100%;
      background: linear-gradient(90deg, #6366f1 60%, #4338ca 100%);
      border-radius: 9999px;
      transition: width 0.4s;
      min-width: 0;
    }
    #progressGrid {
      margin-top: 0.7rem;
      min-width: 0;
      overflow-x: auto;
      display: grid;
      grid-template-columns: repeat(4, minmax(180px, 1fr));
      gap: 1.1rem;
    }
    #progressGrid > div {
      min-width: 170px;
      padding: 1rem 0.7rem;
      font-size: 0.97rem;
      margin-bottom: 0;
      background: #f5f7fa;
      border-radius: 0.9rem;
      box-shadow: 0 2px 9px #6366f111;
      border-width: 2px;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      min-height: 135px;
      position: relative;
    }
    @media (max-width: 900px) {
      #progressGrid {
        grid-template-columns: repeat(8, minmax(140px, 1fr));
        overflow-x: auto;
      }
      #progressGrid > div {
        min-width: 140px;
        padding: 0.7rem 0.5rem;
        font-size: 0.93rem;
        gap: 0.25rem;
      }
    }
    @media (max-width: 600px) {
      #progressGrid {
        grid-template-columns: repeat(16, minmax(125px, 1fr));
        overflow-x: auto;
      }
      #progressGrid > div {
        min-width: 124px;
        padding: 0.6rem 0.2rem;
        font-size: 0.91rem;
      }
    }
    .quiz-btn, .attendance-btn {
      cursor: pointer;
      box-shadow: 0 0px 2px #6366f122;
      font-weight: 600;
      font-size: 0.92rem;
      padding: 0.42rem 0.7rem;
      border-radius: 8px;
    }
    .quiz-btn:hover, .attendance-btn:hover {
      filter: brightness(1.07);
      box-shadow: 0 2px 9px #6366f133;
    }
    table {
      width: 100%;
      table-layout: fixed;
      border-collapse: collapse;
      font-size: 0.97rem;
    }
    th, td {
      word-break: break-word;
      padding: 0.65rem 0.4rem;
      border: 1px solid #e0e4ed;
    }
    th {
      background: #f3f4f6;
      color: #6366f1;
      font-weight: 600;
    }
    /* Modal styles - improved for quiz */
    .custom-modal-bg {
      position: fixed;
      inset: 0;
      background: rgba(60,72,128,0.22);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .custom-modal-bg.show {
      display: flex;
    }
    .custom-modal {
      background: white;
      border-radius: 1.4rem;
      box-shadow: 0 8px 32px #6366f133;
      max-width: 97vw;
      min-width: 300px;
      width: 100%;
      max-width: 390px;
      padding: 2.2rem 1.2rem 1.7rem 1.2rem;
      position: relative;
      text-align: center;
      animation: modalIn .5s;
      max-height: 85vh;
      overflow-y: auto;
    }
    @keyframes modalIn {
      from { opacity: 0; transform: scale(0.95);}
      to { opacity: 1; transform: scale(1);}
    }
    .custom-modal .modal-title {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      color: #6366f1;
    }
    .custom-modal .modal-message {
      font-size: 1.07rem;
      margin-bottom: 1.1rem;
      color: #1B428C;
    }
    .custom-modal .modal-quiz {
      text-align: left;
      background: #f8fafc;
      border-radius: 12px;
      padding: 1rem .7rem;
      margin-bottom: 1.2rem;
      font-size: 1rem;
      border: 1px solid #e0e4ed;
      max-height: 40vh;
      overflow-y: auto;
    }
    .custom-modal .modal-actions {
      margin-top: 1.3rem;
      display: flex;
      gap: .9rem;
      justify-content: center;
    }
    .custom-modal .modal-btn {
      padding: .67rem 1.2rem;
      border-radius: 10px;
      border: none;
      background: #6366f1;
      color: #fff;
      font-size: 1.07rem;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s;
      min-width: 110px;
    }
    .custom-modal .modal-btn.secondary {
      background: #f5f7fa;
      color: #003366;
      border: 1.5px solid #6366f1;
    }
    .custom-modal .close-modal {
      position: absolute;
      top: 11px;
      right: 15px;
      background: transparent;
      border: none;
      font-size: 1.7rem;
      color: #888;
      cursor: pointer;
      opacity: 0.7;
    }
    .custom-modal .close-modal:hover {
      opacity: 1;
    }
    .modal-quiz-options label {
      display: block;
      margin-bottom: .7rem;
      cursor: pointer;
      padding: .35rem .1rem;
      border-radius: 7px;
      transition: background .14s;
      font-size: 1rem;
    }
    .modal-quiz-options input[type="radio"]:checked + span {
      background: #6366f1;
      color: #fff;
      font-weight: 600;
      padding: .2rem .5rem;
    }
    .modal-quiz-options input[type="radio"] {
      margin-right: 0.4em;
    }
    @media (max-width: 600px) {
      .custom-modal {
        max-width: 98vw;
        max-height: 90vh;
        font-size: 0.97rem;
      }
      .custom-modal .modal-quiz {
        font-size: 0.96rem;
        padding: 0.7rem 0.5rem;
        max-height: 50vh;
      }
      .modal-quiz-options label {
        font-size: 0.96rem;
      }
    }
    /* Utility classes (unchanged) */
    .bg-green-600 { background: #16a34a; }
    .bg-green-700 {  background: #15803d; }
    .bg-indigo-600 { background: #6366f1; }
    .bg-indigo-700 { background: #4338ca; }
    .bg-yellow-400 { background: #facc15; }
    .bg-gray-200 { background: #e5e7eb; }
    .bg-gray-50 { background: #f9fafb; }
    .bg-white { background: #fff; }
    .font-semibold { font-weight: 600; }
    .font-bold { font-weight: bold; }
    .rounded { border-radius: 1rem; }
    .shadow { box-shadow: 0 2px 10px #6366f11a; }
    .truncate {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .text-xs { font-size: 0.85rem; }
    .text-sm { font-size: 0.97rem; }
    .text-lg { font-size: 1.19rem; }
    .text-xl { font-size: 1.37rem; }
    .text-green-800 { color: #166534; }
    .text-green-700 { color: #15803d; }
    .text-indigo-800 { color: #4338ca; }
    .text-gray-400 { color: #9ca3af; }
    .text-gray-500 { color: #6b7280; }
    .text-gray-600 { color: #4b5563; }
    .text-gray-700 { color: #374151; }
    .text-red-800 { color: #991b1b; }
    .text-red-100 { background: #fee2e2; }
    .text-green-100 { background: #d1fae5; }
    .bg-green-100 { background: #d1fae5; }
    .bg-red-100 { background: #fee2e2; }
    .bg-indigo-100 { background: #e0e7ff; }
    .bg-gray-100 { background: #f3f4f6; }
    .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
    .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
    .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
    .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
    .ml-2 { margin-left: 0.5rem; }
    .ml-3 { margin-left: 0.75rem; }
    .mt-1 { margin-top: 0.25rem; }
    .mt-2 { margin-top: 0.5rem; }
    .mt-3 { margin-top: 0.75rem; }
    .mt-4 { margin-top: 1rem; }
    .mt-5 { margin-top: 1.25rem; }
    .mt-6 { margin-top: 1.5rem; }
    .mb-1 { margin-bottom: 0.25rem; }
    .mb-2 { margin-bottom: 0.5rem; }
    .mb-4 { margin-bottom: 1rem; }
    .mb-8 { margin-bottom: 2rem; }
    .gap-1 { gap: 0.25rem; }
    .gap-2 { gap: 0.5rem; }
    .gap-3 { gap: 0.75rem; }
    .gap-6 { gap: 1.5rem; }
    .flex { display: flex; }
    .flex-wrap { flex-wrap: wrap; }
    .items-center { align-items: center; }
    .justify-between { justify-content: space-between; }
    .min-w-0 { min-width: 0; }
    .max-w-lg { max-width: 32rem; }
    .max-w-4xl { max-width: 56rem; }
    .w-full { width: 100%; }
    .w-10 { width: 2.5rem; }
    .h-10 { height: 2.5rem; }
    .rounded-full { border-radius: 9999px; }
    .border { border: 1px solid #e0e4ed; }
    .font-medium { font-weight: 500; }
    .relative { position: relative; }
    .absolute { position: absolute; }
    .inset-0 { top:0; right:0; bottom:0; left:0; }
    .z-30 { z-index: 30; }
    .z-9999 { z-index: 9999; }
    .hidden { display: none; }
    .show { display: flex !important; }
    .pointer-events-none { pointer-events: none; }
    .transition { transition: all 0.13s; }
    /* WhatsApp Group Button */
    #whatsappGroupBtn {
      min-width: 190px;
      box-shadow: 0 2px 9px #16a34a22;
    }
    #whatsappGroupBtn:hover {
      background: #128c7e;
    }
    /* Misc */
    input[type="text"], input[type="number"], input[type="file"], select {
      font-family: inherit;
      font-size: 1rem;
      border: 1px solid #e0e4ed;
      border-radius: 7px;
      padding: 0.6rem 0.7rem;
      margin-bottom: 0.4rem;
      outline: none;
      background: #f6f7fb;
      box-sizing: border-box;
    }
    button {
      font-family: inherit;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: 7px;
      padding: 0.6rem 1rem;
      cursor: pointer;
      transition: background 0.13s;
    }
    button:disabled {
      opacity: 0.6;
      pointer-events: none;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <header class="bg-white shadow px-4 py-4 flex flex-wrap items-center justify-between gap-2 min-w-0">
    <h1 class="text-2xl font-bold text-indigo-800 flex-1 min-w-0 truncate">
      CODECX INSTITUTE FOR DEVELOPERS Student Dashboard
      <span class="feature-badge ml-2">Web Developer Program</span>
    </h1>
    <div class="flex items-center gap-2 min-w-0 flex-shrink-0">
      <img id="studentAvatar" class="w-10 h-10 rounded-full flex-shrink-0" src="" alt="avatar" />
      <span id="studentNameHeader" class="font-semibold truncate max-w-[110px]"></span>
      <button onclick="logout()" class="ml-1 px-4 py-1 bg-red-600 text-white rounded hover:bg-red-700 flex-shrink-0">Logout</button>
    </div>
  </header>
  <main class="max-w-4xl mx-auto py-8 px-2">
    <!-- Profile -->
    <section class="bg-white rounded shadow p-6 mb-8" id="profileSection">
      <h2 class="text-xl font-semibold mb-4">Profile</h2>
      <div class="flex items-center mb-4 flex-wrap gap-3 min-w-0">
        <img id="studentPassport" class="w-20 h-20 rounded-full border mr-6" src="" alt="Passport"/>
        <div class="min-w-0">
          <div id="studentFullName" class="text-lg font-bold truncate"></div>
          <div id="studentMatric" class="text-sm text-gray-500 truncate"></div>
          <div id="studentEmail" class="text-sm text-gray-600 truncate"></div>
          <div id="studentPhone" class="text-sm text-gray-600 truncate"></div>
          <div id="studentStatus" class="text-sm mt-2"></div>
        </div>
      </div>
    </section>
    <!-- Masterclass Features (locked if unpaid) -->
    <section id="masterclassSection" class="feature-section bg-white rounded shadow p-6 mb-8">
      <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
        Masterclass Features
        <span class="feature-badge"></span>
      </h2>
      <div class="grid grid-cols-2 gap-6">
        <div class="resource-card">
          <div class="title"><i class="bi bi-camera-video mr-2"></i> Live Coding Sessions</div>
          <div class="desc">Join weekly live interactive coding classes with top instructors. Participate, ask questions, and build projects together.</div>
          <div class="link">Next session: <span id="nextSession"></span></div>
        </div>
        <div class="resource-card">
          <div class="title"><i class="bi bi-collection-play mr-2"></i> Video Library</div>
          <div class="desc">Access a library of recorded masterclass lessons & practical walk-throughs, available 24/7.</div>
          <a href="video-resources.html" class="link" id="videoLibraryLink" target="_blank">Browse videos</a>
        </div>
        <div class="resource-card">
          <div class="title"><i class="bi bi-code-slash mr-2"></i> Challenge & Projects</div>
          <div class="desc">Take part in exclusive coding challenges, hackathons, and practical projects for certificates and portfolio.</div>
          <a href="challenge.html" class="link" id="challengesLink" target="_blank">See current challenge</a>
        </div>
        <div class="resource-card">
          <div class="title"><i class="bi bi-journal-richtext mr-2"></i> Developer's Notes & Resources</div>
          <div class="desc">Download handouts, cheatsheets, and curated learning resources from top instructors for web devs.</div>
          <a href="resource.html" class="link" id="resourcesLink" target="_blank">Access Resources</a>
        </div>
      </div>
      <i class="bi bi-lock-fill padlock-icon" style="display:none"></i>
      <div id="unlockMessage" class="mt-5 text-center text-indigo-700 font-semibold hidden">
        <i class="bi bi-lock-fill"></i> These features are locked. Please complete payment to unlock full access!
      </div>
      <div class="mt-6 text-center">
        <button id="whatsappGroupBtn"
          class="px-4 py-2 rounded font-semibold bg-green-600 text-white shadow hover:bg-green-700 transition disabled:opacity-60 disabled:pointer-events-none"
          style="min-width: 190px;">
          <i class="bi bi-whatsapp mr-1"></i> Join WhatsApp Group
        </button>
        <div id="whatsappNote" class="text-xs text-gray-600 mt-1"></div>
      </div>
    </section>
    <!-- Chat/Community -->
    <section class="bg-white rounded shadow p-6 mb-8">
      <h2 class="text-xl font-semibold mb-4">Community & Chat</h2>
      <div class="scroll-area" id="chatArea">
        <!-- Messages here -->
      </div>
      <form id="chatForm" class="flex gap-2">
        <input id="chatInput" type="text" placeholder="Type your message..." class="flex-1 px-3 py-2 border rounded" autocomplete="off"/>
        <button type="submit" class="px-5 py-2 bg-indigo-600 text-white rounded">Send</button>
      </form>
    </section>
    <!-- Courses, Progress, Payments, Activity -->
    <section class="bg-white rounded shadow p-6 mb-8" id="coursesSection">
      <h2 class="text-xl font-semibold mb-4">Courses</h2>
      <div id="coursesList" class="flex flex-wrap gap-3 mb-4"></div>
      <div class="flex gap-2 flex-wrap">
        <select id="courseSelect" class="px-2 py-1 border rounded bg-white">
          <option value="">-- Select a Course --</option>
          <option value="HTML Only">HTML Only</option>
          <option value="CSS Only">CSS Only</option>
          <option value="JavaScript Only">JavaScript Only</option>
          <option value="HTML and CSS only">HTML and CSS only</option>
          <option value="HTML and JavaScript only">HTML and JavaScript only</option>
          <option value="CSS and JavaScript Only">CSS and JavaScript Only</option>
          <option value="All three">All three (HTML, CSS, JS)</option>
          <option value="Full Backend">Full Backend</option>
          <option value="FullStack">FullStack</option>
          <option value="Coupon Code">Coupon Code</option>
        </select>
        <button onclick="addCourse()" class="px-3 py-1 bg-indigo-600 text-white rounded">Add Course</button>
      </div>
    </section>

    <section class="bg-white rounded shadow p-6 mb-8" id="paymentsSection">
      <h2 class="text-xl font-semibold mb-4">Payments</h2>
      <div id="paymentStatus" class="mb-2"></div>
      <table class="min-w-full text-sm">
        <thead>
          <tr>
            <th class="px-2 py-1 border">Date</th>
            <th class="px-2 py-1 border">Amount</th>
            <th class="px-2 py-1 border">Status</th>
            <th class="px-2 py-1 border">Ref</th>
          </tr>
        </thead>
        <tbody id="paymentsTable"></tbody>
      </table>
      <button id="payNowBtn" class="mt-3 px-3 py-1 bg-indigo-600 text-white rounded">Pay Now</button>
    </section>
    <!-- Payment Modal -->
    <div class="custom-modal-bg" id="paymentModalBg">
      <div class="custom-modal" id="paymentModal">
        <button class="close-modal" onclick="closePaymentModal()">&times;</button>
        <div class="modal-title"><i class="bi bi-credit-card-2-front mr-2"></i> Pay for Masterclass</div>
        <div class="modal-message">Complete your payment securely with Paystack. Your dashboard will be updated automatically after successful payment.</div>
        <div class="modal-actions">
          <a href="https://paystack.shop/pay/codec" target="_blank" class="modal-btn" id="paystackProceedBtn">
            <i class="bi bi-arrow-right-circle mr-1"></i> Proceed to Paystack
          </a>
          <button class="modal-btn secondary" onclick="closePaymentModal()">Cancel</button>
        </div>
        <div class="mt-4 text-xs text-gray-500">After payment, you will be redirected for verification.</div>
      </div>
    </div>
    <!-- Modal for Day Quiz -->
    <div class="custom-modal-bg" id="dayQuizModalBg" style="display:none">
      <div class="custom-modal" id="dayQuizModal">
        <button class="close-modal" onclick="closeDayQuizModal()">&times;</button>
        <div id="dayQuizContent"></div>
      </div>
    </div>
    <!-- Modal for Receipt/Payment -->
    <div id="receiptModal" class="fixed inset-0 z-30 bg-black bg-opacity-60 flex items-center justify-center hidden">
      <div class="bg-white p-6 rounded shadow relative max-w-lg w-full">
        <button onclick="closeReceipt()" class="absolute top-2 right-2 text-lg font-bold">&times;</button>
        <div id="receiptModalContent"></div>
      </div>
    </div>
          <section class="bg-white rounded-xl shadow p-6 mb-8" id="assignmentSection">
  <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
    <i class="bi bi-upload mr-2 text-indigo-600"></i> Assignment Submission
  </h2>
  <form id="assignmentForm" class="flex flex-wrap gap-3 items-center mb-5">
    <input id="assignmentInput" type="file" class="block rounded border p-2 bg-gray-50 flex-1" />
    <button type="button" onclick="submitAssignment()" class="px-4 py-2 bg-indigo-600 text-white rounded font-semibold hover:bg-indigo-700 flex-shrink-0">
      <i class="bi bi-cloud-arrow-up mr-1"></i> Submit Assignment
    </button>
    <span id="assignmentStatus" class="ml-2 text-green-700 font-semibold"></span>
  </form>
  <div class="mt-2">
    <h3 class="text-lg font-semibold mb-3 text-gray-700 flex items-center gap-1">
      <i class="bi bi-clock-history mr-1 text-indigo-400"></i> Submission History
    </h3>
    <div id="assignmentHistory" class="space-y-4">
      <!-- Assignment items will be rendered here -->
    </div>
  </div>
</section>
    <!-- Progress Section - with Progress Bar -->
    <section class="bg-white rounded shadow p-6 mb-8" id="progressSection">
      <h2 class="text-xl font-semibold mb-4">Progress</h2>
      <div id="progressBar" class="w-full bg-gray-200 rounded-full h-4 mb-6 shadow">
        <div id="progressBarFill" class="bg-indigo-600 h-4 rounded-full" style="width: 0%;"></div>
      </div>
      <div id="progressSummary" class="mb-4 font-semibold text-indigo-800"></div>
      <div id="progressGrid" class="grid grid-cols-2 md:grid-cols-4 gap-3 overflow-x-auto" style="min-width: 0;"></div>
    </section>
    <section class="bg-white rounded shadow p-6" id="notesSection">
      <h2 class="text-xl font-semibold mb-4">Admin Notes</h2>
      <div id="adminNote" class="text-gray-700"></div>
    </section>
        <section class="bg-white rounded shadow p-6 mb-8" id="activitySection">
      <h2 class="text-xl font-semibold mb-4">Activity</h2>
      <table class="min-w-full text-sm mb-2">
        <thead>
          <tr>
            <th class="px-2 py-1 border">Date</th>
            <th class="px-2 py-1 border">Activity</th>
            <th class="px-2 py-1 border">Status</th>
          </tr>
        </thead>
        <tbody id="activityTable"></tbody>
      </table>
      <div class="flex gap-2 mt-4">
        <span id="attendanceStatus" class="ml-3 font-semibold"></span>
      </div>

    </section>
  </main>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <script>
// Loader functions
function showStudentLoader() {
  if (document.getElementById('studentDataLoader')) return;
  const loaderHtml = `
    <div id="studentDataLoader" style="
      position:fixed;
      top:0;left:0;width:100vw;height:100vh;
      background:rgba(245,247,255,0.87);
      z-index:9999;display:flex;
      align-items:center;justify-content:center;
      transition:opacity 0.3s;
    ">
      <div style="text-align:center;">
        <div style="display:inline-block; margin-bottom:18px;">
          <svg width="64" height="64" viewBox="0 0 50 50" style="animation:spin 1.3s linear infinite;">
            <circle cx="25" cy="25" r="20" fill="none" stroke="#6366f1" stroke-width="6" stroke-linecap="round" stroke-dasharray="90,150">
              <animateTransform attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="1.3s" repeatCount="indefinite"/>
            </circle>
          </svg>
        </div>
        <div style="font-size:1.1rem;color:#6366f1;font-weight:600;">Loading your dashboard...</div>
        <div style="color:#64748b;font-size:0.93rem;margin-top:8px;">Please wait while we fetch your data.</div>
      </div>
    </div>
    <style>
      @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
  `;
  document.body.insertAdjacentHTML('beforeend', loaderHtml);
}

function hideStudentLoader() {
  const loader = document.getElementById('studentDataLoader');
  if (loader) {
    loader.style.opacity = '0';
    setTimeout(() => loader.remove(), 350);
  }
}

function loadDashboardData(token) {
  showStudentLoader();
  Promise.all([
    renderActivity();
    
  ])
  .then(([profile, assignments, payments]) => {
    try {
      window.student = profile;
      window.assignments = assignments;
      window.payments = payments;
      renderAssignmentHistory(student.assignmentHistory || []);
      renderCourses();
      
      renderPayments();
      renderProgressSection();
    } catch (err) {
      console.error('Render error:', err);
      showToast('Failed to render dashboard: ' + err, 'error');
    }
  })
  .catch(err => {
    console.error('Error loading dashboard:', err);
    showToast('Failed to load dashboard: ' + err, 'error');
  })
  .finally(() => {
    hideStudentLoader();
  });
}

// Usage example (run after DOMContentLoaded):
document.addEventListener("DOMContentLoaded", function() {
  const token = localStorage.getItem('codecx_token');
  if (token) {
    loadDashboardData(token);
  } else {
    window.location.href = "login.html";
  }
});


// --- End of loader code ---
// Drop-in Toast Modal & Loader System
(function() {
  // Inject toast modal HTML if not present
  if (!document.getElementById('toastModalBg')) {
    const modalBg = document.createElement('div');
    modalBg.id = 'toastModalBg';
    modalBg.className = 'fixed inset-0 z-50 bg-black bg-opacity-20 flex items-center justify-center hidden';
    modalBg.innerHTML = `
      <div id="toastModal" class="bg-white rounded-xl shadow-lg p-6 max-w-lg w-full text-center relative">
        <div id="toastSpinner" class="mb-3" style="display:none;">
          <div class="spin-anim inline-block w-8 h-8 border-4 border-indigo-400 border-t-transparent rounded-full"></div>
        </div>
        <div id="toastTitle" class="font-bold text-lg text-indigo-700 mb-2"></div>
        <div id="toastMessage" class="text-gray-700 mb-4"></div>
        <button id="toastCloseBtn" class="px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Close</button>
      </div>
    `;
    document.body.appendChild(modalBg);

    // Add spinner animation style
    if (!document.getElementById('spinAnimStyle')) {
      const style = document.createElement('style');
      style.id = 'spinAnimStyle';
      style.textContent = `
        @keyframes spin { to { transform: rotate(360deg); } }
        .spin-anim { animation: spin 1s linear infinite; }
      `;
      document.head.appendChild(style);
    }
    // Close button logic
    document.getElementById('toastCloseBtn').onclick = function() {
      modalBg.classList.add('hidden');
    };
    modalBg.onclick = function(e) {
      if (e.target === modalBg) modalBg.classList.add('hidden');
    };
  }

  // Expose global functions
  window.showToastModal = function(title, message, type = "info", showSpinner = false) {
    document.getElementById('toastTitle').textContent = title || '';
    document.getElementById('toastMessage').innerHTML = message || ''; // <-- Use innerHTML here!
    document.getElementById('toastSpinner').style.display = showSpinner ? 'block' : 'none';
    document.getElementById('toastModalBg').classList.remove('hidden');
    document.getElementById('toastTitle').style.color =
      type === 'success' ? '#16a34a' :
      type === 'error' ? '#dc2626' : '#6366f1';
};
  window.hideToastModal = function() {
    document.getElementById('toastModalBg').classList.add('hidden');
  };
})();
    

    const API_BASE = "https://examguide.onrender.com/api/codecxreg";
const WS_GROUP_LINK = "https://chat.whatsapp.com/HErvit5xKqY4cMGm9hsi5R?mode=ems_copy_c";
let student = {};
let token = localStorage.getItem('codecx_token');
let chatPollingInterval = null;
let ws = null, reconnectTimeout = null;

// Toast utility
function showToast(msg, type = "info") {
  Toastify({
    text: msg,
    duration: 10000,
    gravity: "top",
    position: "center",
    backgroundColor: type === "success" ? "#16a34a" :
      type === "error" ? "#dc2626" : "#6366f1"
  }).showToast();
}
function logout() {
  localStorage.removeItem('codecx_token');
  localStorage.removeItem('matricNumber');
  window.location.href = "login.html";
}

    
// Receipt Modal
function showReceiptModal(html) {
  document.getElementById("receiptModalContent").innerHTML = html;
  document.getElementById("receiptModal").classList.remove("hidden");
}
function closeReceipt() {
  document.getElementById("receiptModal").classList.add("hidden");
}
document.getElementById("receiptModal").addEventListener("click", function (e) {
  if (e.target === this) closeReceipt();
});

// Payment Modal
document.getElementById("payNowBtn").onclick = function () {
  document.getElementById("paymentModalBg").classList.add("show");
};
function closePaymentModal() {
  document.getElementById("paymentModalBg").classList.remove("show");
}

// WhatsApp Group Button Logic
function updateWhatsAppBtn() {
  const btn = document.getElementById("whatsappGroupBtn");
  const note = document.getElementById("whatsappNote");
  if (student.hasPaid) {
    btn.disabled = false;
    btn.onclick = () => window.open(WS_GROUP_LINK, "_blank");
    note.textContent = "Access to the closed WhatsApp group is reserved for paid students.";
  } else {
    btn.disabled = true;
    btn.onclick = null;
    note.textContent = "Pay for the masterclass to access the exclusive WhatsApp group.";
  }
}

// Loader & Toast Modal
function showLoader(show = true) {
  let loader = document.getElementById("globalLoaderModal");
  if (!loader) {
    loader = document.createElement("div");
    loader.id = "globalLoaderModal";
    loader.style = "position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:99999;background:rgba(60,72,128,0.16);";
    loader.innerHTML = `<div style="padding:2.2rem 2.8rem;background:#fff;border-radius:1.2rem;box-shadow:0 6px 32px #6366f133;display:flex;flex-direction:column;align-items:center;">
      <div class="spinner" style="width:44px;height:44px;border:5px solid #6366f1;border-top:5px solid #fff;border-radius:50%;animation:spin 1.1s linear infinite"></div>
      <div style="font-size:1.1rem;color:#6366f1;font-weight:600;margin-top:1.2rem">Loading, please wait...</div>
    </div>`;
    document.body.appendChild(loader);
    // Spinner CSS
    if (!document.getElementById('globalSpinnerStyle')) {
      const style = document.createElement('style');
      style.id = 'globalSpinnerStyle';
      style.textContent = '@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}';
      document.head.appendChild(style);
    }
  }
  loader.style.display = show ? 'flex' : 'none';
}

function showToastModal(title, message, type="info") {
  let modal = document.getElementById("globalToastModal");
  if (!modal) {
    modal = document.createElement("div");
    modal.id = "globalToastModal";
    modal.style = "position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:99999;background:rgba(60,72,128,0.13);";
    modal.innerHTML = `<div style="padding:2.4rem 2.5rem;background:#fff;border-radius:1.25rem;box-shadow:0 8px 40px #6366f155;display:flex;flex-direction:column;align-items:center;max-width:95vw;">
      <div id="toastIcon" style="font-size:2.3rem;margin-bottom:0.7rem"></div>
      <div id="toastTitle" style="font-size:1.23rem;font-weight:700;color:#6366f1;margin-bottom:0.7rem"></div>
      <div id="toastMsg" style="font-size:1.07rem;color:#444;margin-bottom:1.2rem;text-align:center"></div>
      <button onclick="document.getElementById('globalToastModal').style.display='none'" style="padding:0.6rem 2rem;background:#6366f1;color:#fff;border:none;border-radius:.7rem;font-weight:600;cursor:pointer;font-size:1.05rem">Close</button>
    </div>`;
    document.body.appendChild(modal);
  }
  document.getElementById("toastTitle").textContent = title;
  document.getElementById("toastMsg").textContent = message;
  let icon = "ℹ️";
  if (type === "success") icon = "✅";
  if (type === "error") icon = "❌";
  document.getElementById("toastIcon").textContent = icon;
  modal.style.display = "flex";
}

// Helper: Allowed topics based on registered courses
function getAllowedTopics(courses) {
  const courseStr = (courses || []).map(c => c.name.toLowerCase()).join(" ");
  return {
    HTML: /html/.test(courseStr),
    CSS: /css/.test(courseStr),
    JS: /javascript|js/.test(courseStr),
  };
}

// Helper: Format date as YYYY-MM-DD
function formatDate(date) {
  const yyyy = date.getFullYear();
  const mm = String(date.getMonth() + 1).padStart(2, '0');
  const dd = String(date.getDate()).padStart(2, '0');
  return `${yyyy}-${mm}-${dd}`;
}

// Set program start date (Monday 8th September 2025)
const PROGRAM_START_DATE = new Date('2025-09-08T00:00:00');

// Generate session dates for 60 days
const sessions = [];
for (let i = 0; i < 60; i++) {
  const sessionDate = new Date(PROGRAM_START_DATE);
  sessionDate.setDate(sessionDate.getDate() + i);
  let topic = "";
  if (i < 20) topic = `HTML: Day ${i + 1}`;
  else if (i < 40) topic = `CSS: Day ${i - 19}`;
  else topic = `JavaScript: Day ${i - 39}`;
  sessions.push({
    day: i + 1,
    topic,
    topicKey: i < 20 ? "HTML" : (i < 40 ? "CSS" : "JS"),
    date: formatDate(sessionDate)
  });
}

// Helper: Get quiz/attendance status for a day
function getQuizStatus(day) {
  if (!student.activities) return { quiz: false, attendance: false };
  const quizAct = student.activities.find(a => a.activity.startsWith(`Quiz completed - Day ${day}`));
  const attAct = student.activities.find(a => a.activity === `Attendance marked - Day ${day}`);
  return {
    quiz: !!quizAct,
    attendance: !!attAct
  };
}

// Render progress grid with time/date restrictions and quiz/attendance gating
function renderProgressSection() {
  let completed = 0;
  const now = new Date();
  const allowedTopics = getAllowedTopics(student.courses);
  // Check time window (8pm to 11:59pm)
  function isWithinWindow(sessionDate) {
    if (formatDate(now) !== sessionDate) return false;
    const hour = now.getHours();
    return (hour >= 16 && hour <= 23);
  }
  document.getElementById("progressSummary").textContent = "";
  const grid = document.getElementById("progressGrid");
  grid.innerHTML = "";
  let visibleSessions = 0;
  let visibleCompleted = 0;

  sessions.forEach(s => {
    // Only show session if topic is allowed
    if (!allowedTopics[s.topicKey]) return;

    visibleSessions++;
    const status = getQuizStatus(s.day);
    if (status.quiz && status.attendance) visibleCompleted++;
    let color = "border-gray-300";
    if (s.day <= 20) color = "border-yellow-400";
    else if (s.day <= 40) color = "border-blue-400";
    else color = "border-green-400";

    // Determine quiz/attendance access
    const canAccess = isWithinWindow(s.date);

    grid.innerHTML += `
      <div class="border ${color} rounded-lg p-3 bg-gray-50 flex flex-col items-start relative min-w-0">
        <div class="font-bold text-sm mb-1">${s.topic}</div>
        <div class="text-xs text-gray-500 mb-2">Day ${s.day} | <span>${s.date}</span></div>
        <div class="flex items-center gap-2 mb-2">
          ${status.quiz
        ? `<span class="text-green-700 flex items-center"><i class="bi bi-check-circle-fill mr-1"></i>Quiz Done</span>`
        : canAccess
          ? `<button class="px-2 py-1 text-xs bg-indigo-600 text-white rounded quiz-btn" data-day="${s.day}">Take Quiz</button>`
          : `<button class="px-2 py-1 text-xs bg-gray-400 text-white rounded quiz-btn" data-day="${s.day}" disabled title="Quiz opens ${s.date} between 8pm-11:59pm">Locked</button>`
      }
        </div>
        <div class="flex items-center gap-2">
          ${status.attendance
        ? `<span class="text-green-700 flex items-center"><i class="bi bi-person-check-fill mr-1"></i>Attendance Marked</span>`
        : (status.quiz && canAccess)
          ? `<button class="px-2 py-1 text-xs bg-green-600 text-white rounded attendance-btn" data-day="${s.day}">Mark Attendance</button>`
          : `<button class="px-2 py-1 text-xs bg-gray-400 text-white rounded attendance-btn" data-day="${s.day}" disabled title="Attendance opens ${s.date} between 8pm-11:59pm">Locked</button>`
      }
        </div>
      </div>
    `;
  });

  document.getElementById("progressSummary").textContent =
    `Completed: ${visibleCompleted} / ${visibleSessions} days`;

  // Quiz button click event
  document.querySelectorAll(".quiz-btn:not([disabled])").forEach(btn => {
    btn.onclick = async function () {
      const day = btn.getAttribute("data-day");
      await showQuizModal(day);
    };
  });

  // Attendance button click event
  document.querySelectorAll(".attendance-btn:not([disabled])").forEach(btn => {
    btn.onclick = async function () {
      const day = btn.getAttribute("data-day");
      await markAttendance(day);
    };
  });
}

// ---- QUIZ MODAL LOGIC ----
async function showQuizModal(day) {
  showLoader(true);
  try {
    const resp = await fetch(`${API_BASE}/quiz/${day}`, {
      headers: { "Authorization": "Bearer " + token }
    });
    const data = await resp.json();
    showLoader(false);
    if (!resp.ok) {
      showToastModal("Error Loading Quiz", data.message || "Could not load quiz", "error");
      return;
    }
    let html = `<div class="modal-title">Day ${day} Quiz</div>
      <form id="quizForm">
        <div class="modal-quiz">`;
    data.questions.forEach((q, i) => {
      html += `
        <div><b>Q${i + 1}:</b> ${q.question}</div>
        <div class="modal-quiz-options">` +
        q.options.map((opt, idx) =>
          `<label>
            <input type="radio" name="q${i}" value="${opt}" ${idx === 0 ? "checked" : ""}/>
            <span>${opt}</span>
          </label>`
        ).join("") + `</div>`;
    });
    html += `</div>
      <div class="modal-actions">
        <button type="submit" class="modal-btn" id="submitQuizBtn"><span>Submit Quiz</span></button>
        <button type="button" class="modal-btn secondary" onclick="closeDayQuizModal()">Cancel</button>
      </div>
      </form>
      <div id="quizResult" style="margin-top:1.2rem"></div>`;
    document.getElementById("dayQuizContent").innerHTML = html;
    document.getElementById("dayQuizModalBg").style.display = "flex";

    document.getElementById("quizForm").onsubmit = async function (e) {
      e.preventDefault();
      showLoader(true);
      const submitBtn = document.getElementById("submitQuizBtn");
      submitBtn.disabled = true;
      // Prepare answers
      const answers = [...document.querySelectorAll('input[type="radio"]:checked')].map(input => input.value);

      try {
        // Submit answers & get score from backend
        const scoreResp = await fetch(`${API_BASE}/quiz/score/${day}`, {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ answers })
        });

        const scoreData = await scoreResp.json();
        showLoader(false);
        if (!scoreResp.ok) {
          showToastModal("Quiz Submission Failed", scoreData.message || "Error grading quiz", "error");
          submitBtn.disabled = false;
          return;
        }

        const score = scoreData.score;
        const total = scoreData.total;
        const percent = Math.round((score / total) * 100);

        document.getElementById("quizResult").innerHTML =
          `<div class="font-bold text-green-700 mb-2"><i class="bi bi-award"></i> Quiz Score: ${score} / ${total} (${percent}%)</div>`;

        // Record quiz completion (with score)
        await markQuizCompletedWithScore(day, score);

        // Auto-mark attendance
        await markAttendance(day, true);

        showToastModal("Quiz Submitted", `Your score: ${score} / ${total} (${percent}%). Attendance marked for Day ${day}.`, "success");

        // Wait a bit for user to see score, then close modal & reload dashboard
        setTimeout(() => {
          closeDayQuizModal();
          reloadDashboard();
        }, 1800);

      } catch (err) {
        showLoader(false);
        showToastModal("Quiz Submission Error", err.message, "error");
        submitBtn.disabled = false;
      }
    };
  } catch (err) {
    showLoader(false);
    showToastModal("Quiz Modal Error", err.message, "error");
  }
}

// Helper: Record quiz completed activity WITH score
async function markQuizCompletedWithScore(day, score) {
  showLoader(true);
  try {
    const resp = await fetch(`${API_BASE}/activities`, {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + token,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ activity: `Quiz completed - Day ${day} (Score: ${score})` })
    });
    const data = await resp.json();
    showLoader(false);
    if (!resp.ok) throw new Error(data.message);
    return true;
  } catch (err) {
    showLoader(false);
    showToastModal("Quiz Completion Error", err.message, "error");
    throw new Error("Failed to record quiz completion: " + err.message);
  }
}

// Helper: Mark attendance for day (optionally silent on error if auto)
async function markAttendance(day, auto = false) {
  showLoader(true);
  try {
    const resp = await fetch(`${API_BASE}/activities`, {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + token,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ activity: `Attendance marked - Day ${day}` })
    });
    const data = await resp.json();
    showLoader(false);
    if (!resp.ok) throw new Error(data.message);
    return true;
  } catch (err) {
    showLoader(false);
    if (!auto) showToastModal("Attendance Error", err.message, "error");
    if (auto) console.warn("Auto attendance failed:", err.message);
    return false;
  }
}

// Helper: Close quiz modal
function closeDayQuizModal() {
  document.getElementById("dayQuizModalBg").style.display = "none";
}


async function reloadDashboard() {
  if (!token) { logout(); return; }
  try {
    const resp = await fetch(`${API_BASE}/me`, {
      headers: { "Authorization": "Bearer " + token }
    });
    const data = await resp.json();
    if (!resp.ok) throw new Error(data.message);
    student = data;

window.student = student; // <-- Add this line!

    localStorage.setItem('matricNumber', student.matricNumber);

    document.getElementById("studentAvatar").src = student.passportBase64 || "https://ui-avatars.com/api/?name=" + encodeURIComponent(student.fullName);
    document.getElementById("studentPassport").src = student.passportBase64 || "https://ui-avatars.com/api/?name=" + encodeURIComponent(student.fullName);
    document.getElementById("studentFullName").textContent = student.fullName;
    document.getElementById("studentNameHeader").textContent = student.fullName;
    document.getElementById("studentMatric").textContent = student.matricNumber;
    document.getElementById("studentEmail").textContent = student.email;
    document.getElementById("studentPhone").textContent = student.phone;
    document.getElementById("studentStatus").innerHTML = student.hasPaid
      ? `<span class="bg-green-100 text-green-800">Paid & Active</span>`
      : `<span class="bg-red-100 text-red-800">Unpaid (Limited Access)</span>`;
    updateWhatsAppBtn();

    

    // Lock masterclass features if unpaid
    const locked = !student.hasPaid;
    document.getElementById("masterclassSection").classList.toggle("locked", locked);
    document.querySelector("#masterclassSection .padlock-icon").style.display = locked ? "block" : "none";
    document.getElementById("unlockMessage").classList.toggle("hidden", !locked);


    renderAssignmentHistory(student.assignmentHistory || []);
  
    renderCourses();
    renderActivity();
    renderPayments();
    renderProgressSection();
    
    document.getElementById("adminNote").textContent = student.adminNote || "";
    
  } catch (err) {
    showToast("Error loading dashboard: " + err.message, "error");
    logout();
  }
}
document.addEventListener("DOMContentLoaded", reloadDashboard);
// Courses
function renderCourses() {
  const list = document.getElementById("coursesList");
  list.innerHTML = "";
  (student.courses || []).forEach(c => {
    list.innerHTML += `<span class="px-3 py-1 rounded bg-gray-200 text-indigo-800 font-semibold flex items-center gap-1">${c.name}
      <button class="ml-2 text-red-700" style="font-size:1.1em" onclick="removeCourse('${c.name}')">&times;</button>
    </span>`;
  });
}
async function addCourse() {
  const select = document.getElementById("courseSelect");
  const courseName = select.value;
  if (!courseName) {
    if (window.showToastModal) {
      showToastModal("Error", "Select a course to add.", "error");
      setTimeout(hideToastModal, 2000);
    } else {
      showToast("Select a course to add.", "error");
    }
    return;
  }
  // Show loader modal if available
  if (window.showToastModal) showToastModal("Adding Course...", "Please wait while we add your course.", "info", true);
  try {
    const resp = await fetch(`${API_BASE}/courses`, {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + token,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ courseName })
    });
    const data = await resp.json();
    if (!resp.ok) throw new Error(data.message);
    await reloadDashboard();
    if (window.showToastModal) {
      showToastModal("Course Added!", "Your course was added successfully.", "success");
      setTimeout(hideToastModal, 2000);
    } else {
      showToast("Course added!", "success");
    }
  } catch (err) {
    if (window.showToastModal) {
      showToastModal("Error", err.message, "error");
      setTimeout(hideToastModal, 2000);
    } else {
      showToast(err.message, "error");
    }
  }
}

async function removeCourse(courseName) {
  if (window.showToastModal) showToastModal("Removing Course...", "Please wait while we remove your course.", "info", true);
  try {
    const resp = await fetch(`${API_BASE}/courses`, {
      method: "DELETE",
      headers: {
        "Authorization": "Bearer " + token,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ courseName })
    });
    const data = await resp.json();
    if (!resp.ok) throw new Error(data.message);
    await reloadDashboard();
    if (window.showToastModal) {
      showToastModal("Course Removed!", "Your course was removed successfully.", "success");
      setTimeout(hideToastModal, 2000);
    } else {
      showToast("Course removed!", "success");
    }
  } catch (err) {
    if (window.showToastModal) {
      showToastModal("Error", err.message, "error");
      setTimeout(hideToastModal, 2000);
    } else {
      showToast(err.message, "error");
    }
  }
}
// Activity
function renderActivity() {
  const table = document.getElementById("activityTable");
  table.innerHTML = "";
  (student.activities || []).slice(-12).reverse().forEach(act => {
    table.innerHTML += `
      <tr>
        <td class="border px-2 py-1">${formatDate(act.date)}</td>
        <td class="border px-2 py-1">${act.activity}</td>
        <td class="border px-2 py-1">${act.status}</td>
      </tr>
    `;
  });
  // Attendance Status
  let latestAttendance = (student.activities || []).filter(a => /^Attendance marked - Day \d+$/.test(a.activity)).slice(-1)[0];
  document.getElementById("attendanceStatus").textContent =
    latestAttendance ? `Last attendance: ${formatDate(latestAttendance.date)}` : "No attendance marked yet.";
}

async function submitAssignment() {
  const inp = document.getElementById("assignmentInput");
  if (!inp.files[0]) {
    if (window.showToastModal) {
      showToastModal("Error", "Select an assignment file to upload.", "error");
      setTimeout(hideToastModal, 20000);
    } else {
      showToast("Select an assignment file to upload.", "error");
    }
    return;
  }
  if (window.showToastModal) showToastModal("Uploading Assignment...", "Please wait while we upload your assignment.", "info", true);

  try {
    let matricNumber = window.student?.matricNumber || localStorage.getItem("matricNumber");
    if (!matricNumber) {
      const profileResp = await fetch(`${API_BASE}/me`, {
        headers: { "Authorization": "Bearer " + token }
      });
      const profile = await profileResp.json();
      if (profile && profile.matricNumber) matricNumber = profile.matricNumber;
    }
    if (!matricNumber) throw new Error("Matric number not found.");

    // Replace slashes with dashes for URL safety
    const safeMatricNumber = matricNumber.replace(/\//g, '-');

    const formData = new FormData();
    formData.append("assignment", inp.files[0]);
    formData.append("title", inp.files[0].name);

    const resp = await fetch(`${API_BASE}/student/matric/${safeMatricNumber}/assignment`, {
      method: "POST",
      headers: { "Authorization": "Bearer " + token },
      body: formData
    });

    const text = await resp.text();
    let data;
    try {
      data = JSON.parse(text);
    } catch (e) {
      throw new Error("Server error: " + text);
    }

    if (!resp.ok) throw new Error(data.message || "Assignment upload failed");

    document.getElementById("assignmentStatus").textContent = "Submitted!";
    inp.value = "";
    await reloadDashboard();

    if (window.showToastModal) {
      showToastModal("Success!", "Assignment submitted successfully.", "success");
      setTimeout(hideToastModal, 20000);
    } else {
      showToast("Assignment submitted!", "success");
    }
  } catch (err) {
  if (err.message === "Failed to fetch") {
    showToastModal("Network Error", "Could not connect to server. Try again later.", "error");
    setTimeout(hideToastModal, 20000);
  } else {
    showToastModal("Error", err.message, "error");
    setTimeout(hideToastModal, 20000);
  }
}
}

function renderPayments() {
  const tb = document.getElementById("paymentsTable");
  tb.innerHTML = "";
  (student.payments || []).slice(-8).reverse().forEach(p => {
    tb.innerHTML += `
      <tr>
        <td class="border px-2 py-1">${formatDate(p.date)}</td>
        <td class="border px-2 py-1">₦${p.amount}</td>
        <td class="border px-2 py-1">${p.status}</td>
        <td class="border px-2 py-1">${p.ref}</td>
      </tr>
    `;
  });
  document.getElementById("paymentStatus").textContent =
    student.hasPaid
      ? `Last payment: ₦${student.payments?.slice(-1)[0]?.amount || ""} (Ref: ${student.lastPaymentRef || ""})`
      : "No payment yet. Please complete payment to unlock features.";
}

// --- Date Formatting ---
function formatDate(dt) {
  const date = new Date(dt);
  if (isNaN(date)) return "";
  return date.toLocaleString();
}


// Update assignment upload flow to call reloadDashboard after successful submission
async function submitAssignment() {
  const inp = document.getElementById("assignmentInput");
  if (!inp.files[0]) {
    showToast("Select an assignment file to upload.", "error");
    return;
  }
  showToastModal("Uploading Assignment...", "Please wait while we upload your assignment.", "info", true);

  try {
    let matricNumber = window.student?.matricNumber || localStorage.getItem("matricNumber");
    if (!matricNumber) throw new Error("Matric number not found.");

    // Replace slashes with dashes for URL safety
    const safeMatricNumber = matricNumber.replace(/\//g, '-');

    const formData = new FormData();
    formData.append("assignment", inp.files[0]);
    formData.append("title", inp.files[0].name);

    const resp = await fetch(`${API_BASE}/student/matric/${safeMatricNumber}/assignment`, {
      method: "POST",
      headers: { "Authorization": "Bearer " + token },
      body: formData
    });

    const text = await resp.text();
    let data;
    try { data = JSON.parse(text); } catch (e) { throw new Error("Server error: " + text); }
    if (!resp.ok) throw new Error(data.message || "Assignment upload failed");

    document.getElementById("assignmentStatus").textContent = "Submitted!";
    inp.value = "";
    await reloadDashboard();

    showToastModal("Success!", "Assignment submitted successfully.", "success");
    setTimeout(hideToastModal, 2000);
  } catch (err) {
    showToastModal("Error", err.message, "error");
    setTimeout(hideToastModal, 2000);
  }
}

// Update assignment delete flow to reload dashboard after deletion
async function deleteAssignment(index) {
  if (!confirm("Delete this assignment? This action cannot be undone.")) return;
  showToastModal("Deleting...", "Please wait...", "info", true);
  try {
    let matricNumber = window.student?.matricNumber || localStorage.getItem("matricNumber");
    if (!matricNumber) throw new Error("Matric number not found.");
    const safeMatricNumber = matricNumber.replace(/\//g, '-');
    const resp = await fetch(`${API_BASE}/student/matric/${safeMatricNumber}/assignment/${index}`, {
      method: "DELETE",
      headers: { "Authorization": "Bearer " + token }
    });
    let data;
    try { data = await resp.json(); } catch (e) { data = {}; }
    if (!resp.ok) throw new Error(data.message || "Delete failed");
    await reloadDashboard();
    showToastModal("Deleted!", "Assignment deleted.", "success");
    setTimeout(hideToastModal, 1500);
  } catch (err) {
    showToastModal("Error", err.message, "error");
    setTimeout(hideToastModal, 2000);
  }
}

// Render assignment history from window.student.assignments
// Render assignment history from window.student.assignmentHistory
function renderAssignmentHistory(assignmentHistory) {
  const history = document.getElementById("assignmentHistory");
  if (!assignmentHistory || !assignmentHistory.length) {
    history.innerHTML = `<div class="text-gray-400 text-center">No assignments submitted yet.</div>`;
    return;
  }
  history.innerHTML = assignmentHistory.map((a, idx) => `
    <div class="flex flex-col md:flex-row items-center bg-gray-50 rounded-lg shadow-sm px-4 py-3 gap-4">
      <div class="flex-1 min-w-0">
        <div class="font-semibold text-indigo-700">${a.title || a.fileName || "Assignment"}</div>
        <div class="text-xs text-gray-500">Submitted: ${a.historyDate ? new Date(a.historyDate).toLocaleString() : (a.date ? new Date(a.date).toLocaleString() : "")}</div>
        ${a.mark ? `<div class="text-xs text-green-700">Mark: ${a.mark}</div>` : ""}
        ${a.status ? `<div class="text-xs text-indigo-700">Status: ${a.status}</div>` : ""}
      </div>
      <div class="flex gap-2 mt-2 md:mt-0">
        <button class="px-3 py-1 bg-gray-200 text-indigo-700 rounded font-semibold hover:bg-indigo-100"
          onclick="previewAssignmentHistory(${idx})">
          <i class="bi bi-eye-fill mr-1"></i> Preview
        </button>
      </div>
    </div>
  `).join("");
}

// Helper to escape HTML for safe code preview
function escapeHtml(text) {
  return text.replace(/[&<>"']/g, function (m) {
    return (
      {
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#39;"
      }[m]
    );
  });
}

function getExtension(filename) {
  return filename?.split('.').pop().toLowerCase();
}

// Main preview function for assignment history
function previewAssignmentHistory(index) {
  const assignment = (window.student?.assignmentHistory || [])[index];
  if (!assignment) return;

  const downloadLink = assignment.fileData
    ? `<a href="data:${assignment.fileType};base64,${assignment.fileData}" download="${assignment.fileName}" target="_blank"
      style="color:#6366f1;font-weight:bold;text-decoration:underline;">Download File</a>`
    : `<div class="text-gray-500">No download available.</div>`;

  const ext = getExtension(assignment.fileName);

  let previewHtml = "";
  if (assignment.fileType.startsWith("image/")) {
    previewHtml = `<img src="data:${assignment.fileType};base64,${assignment.fileData}" style="max-width:100%;max-height:300px;border-radius:9px;box-shadow:0 2px 16px #6366f155;" />`;
  } else if (assignment.fileType === "application/pdf") {
    previewHtml = `<iframe src="data:application/pdf;base64,${assignment.fileData}" width="100%" height="400" style="border-radius:8px;border:1px solid #eee;"></iframe>`;
  } else if (
    assignment.fileType.startsWith("text/") ||
    ["application/javascript", "text/html", "text/css"].includes(assignment.fileType) ||
    ["js", "css", "html", "txt"].includes(ext)
  ) {
    let decoded = "";
    try {
      decoded = atob(assignment.fileData);
    } catch (e) {
      decoded = "Unable to decode file data.";
    }

    let codeType = ext;
    let codeBlock = "";
    if (ext === "html") {
      codeBlock += `<div style="margin-bottom:1.2em;">
        <span style="font-weight:600;color:#4338ca;">Live HTML Preview:</span>
        <iframe srcdoc="${escapeHtml(decoded)}" style="width:98%;height:160px;border:1px solid #eee;border-radius:7px;background:white;box-shadow:0 2px 12px #6366f122;"></iframe>
      </div>`;
      codeType = "html";
    }
    // Use Prism.js classes for syntax highlighting
    codeBlock += `<pre style="max-height:180px;overflow:auto;text-align:left;background:#f8fafc;border-radius:8px;padding:0.7em;font-size:0.97em;">
      <code class="language-${codeType}">${escapeHtml(decoded)}</code>
    </pre>`;
    previewHtml = codeBlock;
  } else {
    previewHtml = `<div class="text-gray-500">Preview not available for this file type. Please download to view.</div>`;
  }

  let html = `<div style="text-align:center;">
    <h2 style="font-size:1.2rem;color:#6366f1;font-weight:700;">${assignment.title || assignment.fileName}</h2>
    <div style="margin:1rem 0;">Submitted: ${assignment.historyDate ? new Date(assignment.historyDate).toLocaleString() : (assignment.date ? new Date(assignment.date).toLocaleString() : "")}</div>
    <div style="margin-bottom:1rem;">${previewHtml}</div>
    <div style="margin-bottom:1.3em;">${downloadLink}</div>
    ${assignment.mark ? `<div>Mark: <b>${assignment.mark}</b></div>` : ""}
    ${assignment.status ? `<div>Status: <b>${assignment.status}</b></div>` : ""}
  </div>`;
  showToastModal("Assignment Preview", html, "info");

  // Wait for modal to render, then trigger Prism
  setTimeout(() => {
    if (window.Prism) Prism.highlightAll();
  }, 100);
}
      
// On page load, fetch and render dashboard
window.addEventListener('DOMContentLoaded', reloadDashboard);
    
// --- Optionally: expose initChat for manual reload ---
window.reloadChat = initChat;
window.addCourse = addCourse;
window.removeCourse = removeCourse;
window.submitAssignment = submitAssignment;
window.closeDayQuizModal = closeDayQuizModal;
window.showQuizModal = showQuizModal;
window.logout = logout;
window.closePaymentModal = closePaymentModal;
window.closeReceipt = closeReceipt;
  </script>
</body>
</html>
